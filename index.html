<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>AI Kiểm Tra & Xuất Bản Thảo Bài Báo - JSLHU</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }

        .container-top {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding: 10px 10px 0 10px;
            box-sizing: border-box;
        }

        .container-bottom {
            padding: 0 10px 10px 10px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: auto;
            padding: 30px;
        }

        .left {
            background: #e8f4fd;
        }

        .middle {
            background: #fff3e0;
        }

        .preview-wrapper {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.15);
            padding: 10px;
            margin-top: 10px;
        }

        .preview {
            width: 240mm;
            min-height: 297mm;
            margin: 0 auto;
            padding: 25.4mm 25.4mm 25.4mm 31.8mm;
            box-sizing: border-box;
            font-family: "Times New Roman", Times, serif;
            font-size: 12pt;
            line-height: 1.5;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }

        input,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .english-label {
            color: #555;
            font-size: 0.9em;
            margin-top: 4px;
        }

        button {
            padding: 10px 20px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background: #1565c0;
        }

        h2 {
            margin-top: 0;
        }

        /* Định dạng heading trong preview giống Word / hình của bạn */
        #preview-content {
            margin-top: 40px;
            column-count: 2;
            column-gap: 40px;
            line-height: 1.7;
            font-size: 10pt;
            text-align: justify;
            hyphens: auto;
        }

        #preview-content h1,
        #preview-content h2,
        #preview-content h3 {
            font-weight: bold;
            margin: 20px 0 10px;
            break-after: avoid-column;
            /* Tránh heading bị cắt giữa 2 cột */
        }

        #preview-content h1 {
            font-size: 10pt;
            text-transform: uppercase;
            color: #2a4e8a;
            text-align: left;
            /* Hoặc left nếu muốn giống một số mẫu */
            margin: 0px 0 5px;
        }

        #preview-content h2 {
            font-size: 10pt;
            margin-left: 0;
        }

        #preview-content h3 {
            font-size: 13pt;
            margin-left: 20px;
            /* Indent nhẹ cho cấp 2.1, 3.1... */
        }

        #preview-content p {
            margin: 0 0 12px 0;
        }

        #preview-content strong {
            font-weight: bold;
        }

        /* Nếu dùng list ordered trong Quill, style đẹp hơn */
        #preview-content ol {
            margin: 10px 0 10px 30px;
            padding-left: 20px;
        }
    </style>
</head>

<body>

    <!-- Phần trên: Nhập liệu + AI (2 cột) -->
    <div class="container-top">
        <!-- LEFT: Form nhập liệu -->
        <div class="panel left">
            <h2>Nhập nội dung</h2>

            <div class="form-group">
                <label>Tiêu đề (Tiếng Việt):</label>
                <input type="text" id="title_vi" placeholder="Ví dụ: ỨNG DỤNG SPSS VÀ AI TRONG GIÁM SÁT...">
            </div>

            <div class="form-group">
                <label>Tiêu đề (English):</label>
                <input type="text" id="title_en"
                    placeholder="Ví dụ: Applying SPSS and AI to Monitor School Railing Safety...">
            </div>

            <div class="form-group">
                <label>Tác giả:</label>
                <input type="text" id="authors" value="Lê Phương Long, Võ Nhạc Phước, Nguyễn Kim Ngọc Bích">
            </div>

            <div class="form-group">
                <label>Tác giả liên hệ (email):</label>
                <input type="email" id="contact" value="phuonglong@lhu.edu.vn">
            </div>

            <div class="form-group">
                <label>Tóm tắt (Tiếng Việt):</label>
                <textarea id="abstract_vi" rows="5">An toàn lan can học đường là vấn đề cấp thiết toàn cầu...</textarea>
            </div>

            <div class="form-group">
                <label>Abstract (English):</label>
                <textarea id="abstract_en" rows="5">School railing safety is a pressing global issue...</textarea>
            </div>

            <div class="form-group">
                <label>Từ khóa (Tiếng Việt):</label>
                <input type="text" id="keywords_vi"
                    value="SPSS; Trí tuệ nhân tạo (AI); Giám sát hành vi; An toàn lan can; Học sinh vị thành niên">
            </div>

            <div class="form-group">
                <label>Keywords (English):</label>
                <input type="text" id="keywords_en"
                    value="SPSS; Artificial Intelligence (AI); Behavior monitoring; Railing safety; Adolescent students">
            </div>

            <div class="form-group">
                <label>Nội dung chính:</label>
                <div id="editor" class="quill-editor" style="height: 340px;"></div>
            </div>

            <div class="form-group">
                <label>Template Word (.docx):</label>
                <input type="file" id="templateFile" accept=".docx">
            </div>

            <button id="analyzeBtn">AI Kiểm tra & Gợi ý</button>
            <button id="exportBtn">Xuất ra Word (.docx)</button>
        </div>

        <!-- MIDDLE: AI gợi ý -->
        <div class="panel middle">
            <h2>AI Kiểm Tra Chất Lượng</h2>
            <div id="aiFeedback">
                <p>Nhấn nút "AI Kiểm tra & Gợi ý" để nhận phân tích...</p>
            </div>
        </div>
    </div>

    <!-- Phần dưới: Preview full width -->
    <div class="container-bottom">
        <div class="preview-wrapper">
            <h2>Preview giống Word</h2>
            <div class="preview">
                <!-- Header -->
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                    <img src="image.png" alt="JSLHU Logo" style="height:60px;">
                    <div>
                        <span style="font-size:21px; font-family:Cambria; color:#9bb0c9; letter-spacing:1px;">JOURNAL OF
                            SCIENCE</span><br>
                        <span
                            style="font-size:15px; font-family:'Times New Roman', Times, serif; color:#9bb0c9; font-weight:bold;">OF
                            LAC HONG UNIVERSITY</span>
                    </div>
                    <div style="flex:1"></div>
                    <div style="text-align:right;">
                        <span style="font-size:15px; color:#9bb0c9; font-weight:bold;">ISSN: 2525 - 2186</span><br>
                        <span style="font-size:15px; color:#9bb0c9;">Tạp chí Khoa học Lạc Hồng, 2025, 20, 001-005</span>
                    </div>
                </div>
                <hr style="margin:0 0 16px 0;">

                <!-- Tiêu đề tiếng Việt -->
                <div style="text-align:center;">
                    <div style="font-size:20px; color:#2a4e8a; font-weight:bold; text-transform:uppercase; line-height:1.2;"
                        id="preview-title-vi"></div>
                </div>

                <!-- Tác giả & địa chỉ -->
                <div style="text-align:right; font-size:17px; margin-top:8px; font-weight:200;" id="preview-authors">
                </div>
                <div style="text-align:right; font-size:15px; font-style:italic; margin-bottom:4px;">
                    Trường Đại học Lạc Hồng, Số 10 Huỳnh Văn Nghệ, phường Bửu Long, Biên Hòa, Đồng Nai, Vietnam
                </div>
                <div style="text-align:right; font-size:15px; margin-bottom:16px;">
                    *Tác giả liên hệ: <span id="preview-contact" style="font-style:italic;"></span>
                </div>

                <!-- Bảng thông tin + Tóm tắt tiếng Việt -->
                <table style="margin-top:16px; border-collapse:collapse; width:100%; font-size:14px;">
                    <tr>
                        <th style="width:32%; font-size:15px; background:#ffffff; border:1px solid #aaa; padding:8px;">
                            THÔNG TIN BÀI BÁO</th>
                        <th style="font-size:15px; background:#ffffff; border:1px solid #aaa; padding:8px;">TÓM TẮT</th>
                    </tr>
                    <tr>
                        <td style="font-size:15px; vertical-align:top; border:1px solid #aaa; padding:8px;">
                            Ngày nhận: <br>
                            Ngày hoàn thiện: <br>
                            Ngày chấp nhận: <br>
                            Ngày đăng: <br><br>
                            <b>TỪ KHÓA</b><br>
                            <span id="preview-keywords-vi" style="line-height:1.4;"></span>
                        </td>
                        <td style="vertical-align:top; border:1px solid #aaa; padding:8px;" id="preview-abstract-vi">
                        </td>
                    </tr>
                </table>

                <!-- Phần tiếng Anh – trang mới, bố cục giống tiếng Việt hơn (căn phải cho authors & contact) -->
                <div style="margin-top:60px; page-break-before: always; break-before: page;">
                    <div style="text-align:center;">
                        <div style="font-size:20px; color:#2a4e8a; font-weight:bold; text-transform:uppercase; line-height:1.2;"
                            id="preview-title-en"></div>
                    </div>

                    <!-- Tác giả & địa chỉ - căn phải giống phần VI -->
                    <div style="text-align:right; font-size:17px; margin-top:12px; font-weight:500;"
                        id="preview-authors-en"></div>

                    <div style="text-align:right; font-style:italic; font-size:15px; margin-bottom:4px;">
                        Lac Hong University, No. 10 Huynh Van Nghe Street, Buu Long Ward, Bien Hoa, Dong Nai Province,
                        Vietnam
                    </div>

                    <div style="text-align:right; font-size:15px; margin-bottom:24px;">
                        *Corresponding Author: <span id="preview-contact-en" style="font-style:italic;"></span>
                    </div>

                    <!-- Bảng thông tin song song, full-width giống phần VI (không auto margin) -->
                    <table style="margin-top:16px; border-collapse:collapse; width:100%; font-size:14px;">
                        <tr>
                            <th
                                style="width:35%; font-size:15px; background:#ffffff; border:1px solid #aaa; padding:10px;">
                                ARTICLE INFORMATION</th>
                            <th style="font-size:15px; background:#ffffff; border:1px solid #aaa; padding:10px;">
                                ABSTRACT</th>
                        </tr>
                        <tr>
                            <td style="font-size:15px; vertical-align:top; border:1px solid #aaa; padding:10px;">
                                Received: <br>
                                Revised: <br>
                                Accepted: <br>
                                Published: <br><br>
                                <b>KEYWORDS</b><br>
                                <span id="preview-keywords-en" style="line-height:1.5;"></span>
                            </td>
                            <td style="vertical-align:top; border:1px solid #aaa; padding:10px;"
                                id="preview-abstract-en"></td>
                        </tr>
                    </table>
                </div>
                <!-- ... phần tiếng Anh kết thúc ở đây ... -->

                <!-- Nội dung chính (body của bài báo) -->
                <div id="preview-content">
                    <div class="form-group">
                        <label>Nội dung chính:</label>
                        <small style="color:#555; display:block; margin-bottom:8px;">
                            • Sử dụng Heading 1 cho mục lớn (ví dụ: 2. MÔ HÌNH NGHIÊN CỨU – gõ số tay rồi apply Heading
                            1).<br>
                            • Heading 2 cho mục con (2.1 ...).<br>
                            • Dùng numbered list nếu cần danh sách tự động 1. 2. 3.
                        </small>
                        <div id="editor" style="height: 400px; background:white;"></div>
                        <!-- tăng height cho thoải mái -->
                    </div>
                </div>

            </div> <!-- kết thúc .preview -->
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.8/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.48.0/build/docxtemplater.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pizzip-utils@3.1.8/dist/pizzip-utils.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // Khởi tạo Quill
        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],       // H1 = cấp lớn (2.), H2 = cấp 2.1, H3 = cấp nhỏ hơn
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });

        function updatePreview() {
            const title_vi = document.getElementById('title_vi').value.trim();
            const title_en = document.getElementById('title_en').value.trim();
            const authors = document.getElementById('authors').value.trim();
            const contact = document.getElementById('contact').value.trim();
            const abstract_vi = document.getElementById('abstract_vi').value.trim();
            const abstract_en = document.getElementById('abstract_en').value.trim();
            const keywords_vi = document.getElementById('keywords_vi').value.trim();
            const keywords_en = document.getElementById('keywords_en').value.trim();
            const content = quill.root.innerHTML;

            // Tiếng Việt
            document.getElementById('preview-title-vi').textContent = title_vi || "TIÊU ĐỀ BÀI BÁO";
            document.getElementById('preview-abstract-vi').innerHTML = abstract_vi.replace(/\n/g, '<br>') || "Nhập tóm tắt tiếng Việt...";
            document.getElementById('preview-keywords-vi').innerHTML = keywords_vi.replace(/;/g, ';<br>') || "Nhập từ khóa...";

            // Tiếng Anh
            document.getElementById('preview-title-en').textContent = title_en || "ARTICLE TITLE";
            document.getElementById('preview-abstract-en').innerHTML = abstract_en.replace(/\n/g, '<br>') || "Enter English abstract...";
            document.getElementById('preview-keywords-en').innerHTML = keywords_en.replace(/;/g, '; ') || "Enter keywords...";

            // Chung
            document.getElementById('preview-authors').textContent = authors || "Tác giả";
            document.getElementById('preview-contact').textContent = contact || "email@domain.com";
            document.getElementById('preview-authors-en').textContent = authors || "Authors";
            document.getElementById('preview-contact-en').textContent = contact || "email@domain.com";

            // Nội dung chính
            document.getElementById('preview-content').innerHTML = content || "<p style='text-align:center; color:#999;'>Nội dung bài báo sẽ hiển thị ở đây (sử dụng heading trong editor để định dạng mục 2., 2.1...)</p>";
        }

        // Real-time update
        ['title_vi', 'title_en', 'authors', 'contact', 'abstract_vi', 'abstract_en', 'keywords_vi', 'keywords_en'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });
        quill.on('text-change', updatePreview);

        // AI gợi ý (giả lập - bạn có thể nâng cấp sau)
        document.getElementById("analyzeBtn").onclick = async () => {

            const title_vi = document.getElementById("title_vi").value;
            const title_en = document.getElementById("title_en").value;
            const abstract_vi = document.getElementById("abstract_vi").value;
            const abstract_en = document.getElementById("abstract_en").value;
            const keywords_vi = document.getElementById("keywords_vi").value;
            const keywords_en = document.getElementById("keywords_en").value;
            const content = quill.getText();

            const prompt = `
Bạn là chuyên gia biên tập tạp chí khoa học.

Hãy kiểm tra bài báo theo tiêu chuẩn:
1. Tiêu đề: Viết hoa chữ cái đầu, không trùng từ khóa.
2. Tóm tắt: khoảng 150 đến 250 từ, có vấn đề, mục tiêu, phương pháp, kết quả, ý nghĩa.
3. Abstract EN: Dịch sát nghĩa, thì hiện tại đơn cho kết quả.
4. Từ khóa: từ 4 đến 6 cụm, không trùng tiêu đề.
5. Nội dung: Kiểm tra cấu trúc IMRAD, trích dẫn chuẩn.

Dữ liệu bài báo:

Tiêu đề VI: ${title_vi}
Tiêu đề EN: ${title_en}
Tóm tắt VI: ${abstract_vi}
Abstract EN: ${abstract_en}
Từ khóa VI: ${keywords_vi}
Từ khóa EN: ${keywords_en}
Nội dung: ${content}

Hãy phân tích chi tiết và đưa ra gợi ý cải thiện.
  `;

            document.getElementById("aiFeedback").innerHTML = "Đang phân tích...";
            
            try {
                const response = await fetch("https://ai-review-paper.vonhacphuoc.workers.dev", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ text: prompt })
                });

                const data = await response.json();

                if (data.result) {
                    document.getElementById("aiFeedback").innerHTML =
                        data.result.replace(/\n/g, "<br>");
                } else {
                    document.getElementById("aiFeedback").innerHTML =
                        "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
                }
            } catch (error) {
                console.error(error);
                document.getElementById("aiFeedback").innerHTML =
                    "Lỗi gọi AI. Kiểm tra Worker URL hoặc cấu hình API key!";
            }
        };
        // Xuất Word (cập nhật thêm trường tiếng Anh)
        document.getElementById('exportBtn').onclick = async () => {
            const fileInput = document.getElementById('templateFile');
            if (!fileInput.files?.[0]) {
                alert("Vui lòng chọn file template.docx!");
                return;
            }
            if (typeof PizZip === 'undefined') {
                alert("Lỗi load thư viện PizZip. Kiểm tra kết nối mạng hoặc thử refresh trang.");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const zip = new PizZip(e.target.result);
                    const doc = new docxtemplater(zip, {
                        paragraphLoop: true,
                        linebreaks: true,
                        // Thêm nếu cần xử lý HTML từ Quill: dùng raw-xml hoặc custom parser
                    });

                    doc.render({
                        title: document.getElementById('title_vi').value,
                        title_en: document.getElementById('title_en').value,
                        authors: document.getElementById('authors').value,
                        contact: document.getElementById('contact').value,
                        abstract: document.getElementById('abstract_vi').value,
                        abstract_en: document.getElementById('abstract_en').value,
                        keywords: document.getElementById('keywords_vi').value,
                        keywords_en: document.getElementById('keywords_en').value
                    });

                    const blob = doc.getZip().generate({ type: "blob" });
                    saveAs(blob, "Ban_thao_bai_bao.docx");
                } catch (err) {
                    console.error(err);
                    alert("Lỗi xuất file: " + (err.message || "Không xác định. Kiểm tra template.docx có placeholder đúng không."));
                }
            };
            reader.readAsArrayBuffer(fileInput.files[0]);
        };
        updatePreview(); // Khởi chạy lần đầu
    </script>
</body>

</html>